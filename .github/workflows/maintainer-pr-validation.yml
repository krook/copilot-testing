name: Maintainer PR Validation

on:
  pull_request:
    types: [opened, edited, ready_for_review, synchronize]
    paths:
      - 'project-maintainers.csv'

permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  validate-maintainer-pr:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Check PR requirements
        id: check-requirements
        run: |
          # Create a Python script to safely parse the PR body
          cat > check_requirements.py << 'EOF'
          import os
          import re
          
          # Get PR body from environment
          pr_body = os.getenv('PR_BODY', '')
          
          # Debug: Print first 200 chars of PR body
          print(f"PR body preview: {repr(pr_body[:200])}")
          
          # Patterns to match completed checkboxes
          patterns = [
              r'\[[xX]\]\s*You\'ve provided a link to documentation',
              r'\[[xX]\]\s*The maintainer\(s\) also created or updated',
              r'\[[xX]\]\s*You\'ve sent an email with the email address'
          ]
          
          check_results = []
          for i, pattern in enumerate(patterns, 1):
              matches = re.findall(pattern, pr_body, re.IGNORECASE | re.MULTILINE)
              is_checked = len(matches) > 0
              check_results.append(is_checked)
              print(f"Pattern {i}: Found {len(matches)} matches - {'CHECKED' if is_checked else 'UNCHECKED'}")
          
          all_complete = all(check_results)
          print(f"All requirements complete: {all_complete}")
          
          # Write to GitHub output file only
          github_output = os.environ.get('GITHUB_OUTPUT')
          if github_output:
              with open(github_output, 'a') as f:
                  for i, check in enumerate(check_results, 1):
                      f.write(f"check{i}={1 if check else 0}\n")
                  f.write(f"all_required_complete={'true' if all_complete else 'false'}\n")
          EOF
          
          # Run the Python script
          python3 check_requirements.py
        env:
          PR_BODY: ${{ github.event.pull_request.body }}

      - name: Convert to draft if requirements not met
        if: steps.check-requirements.outputs.all_required_complete == 'false' && github.event.pull_request.draft == false
        run: |
          # Convert PR to draft
          gh pr ready --undo ${{ github.event.pull_request.number }}
          
          # Add comment explaining why
          gh pr comment ${{ github.event.pull_request.number }} --body "üöß **This PR has been converted to draft status**

          The first three checkboxes in the PR template must be completed before this PR can be reviewed:
          
          - [ ] You've provided a link to documentation where the project has approved the maintainer changes.
          - [ ] The maintainer(s) also created or updated their LFX Individual Dashboard profile.
          - [ ] You've sent an email with the email address(es) to cncf-maintainer-changes@cncf.io for invitations to Service Desk and mailing lists.
          
          Please complete these requirements and mark the checkboxes as complete, then mark this PR as ready for review."
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Mark as ready for review if requirements met
        if: steps.check-requirements.outputs.all_required_complete == 'true' && github.event.pull_request.draft == true
        run: |
          gh pr ready ${{ github.event.pull_request.number }}
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Analyze CSV changes
        if: steps.check-requirements.outputs.all_required_complete == 'true' && github.event.pull_request.draft == false
        id: analyze-changes
        run: |
          # Get the changes in the CSV file
          git diff HEAD~1 HEAD project-maintainers.csv > csv_changes.diff
          
          # Parse the CSV changes and create the change summary
          python3 << 'EOF'
          import csv
          import sys
          import os
          
          def parse_csv_file(filename):
              """Parse CSV file and return list of rows"""
              rows = []
              try:
                  with open(filename, 'r', newline='', encoding='utf-8') as csvfile:
                      reader = csv.reader(csvfile)
                      for row in reader:
                          if len(row) >= 4:  # Ensure minimum columns
                              rows.append(row)
              except FileNotFoundError:
                  return []
              return rows
          
          def create_change_summary():
              """Analyze changes and create summary"""
              # Get current CSV content
              current_rows = parse_csv_file('project-maintainers.csv')
              
              # Try to get previous version
              os.system('git show HEAD~1:project-maintainers.csv > previous.csv 2>/dev/null || touch previous.csv')
              previous_rows = parse_csv_file('previous.csv')
              
              changes = []
              
              # Create lookup dictionaries for comparison
              # Using combination of project and maintainer name as key
              def make_key(row):
                  if len(row) >= 2:
                      return f"{row[1]}|{row[2]}" if len(row) > 2 else f"{row[1]}|"
                  return ""
              
              previous_dict = {make_key(row): row for row in previous_rows if len(row) >= 2}
              current_dict = {make_key(row): row for row in current_rows if len(row) >= 2}
              
              # Find additions and updates
              for key, current_row in current_dict.items():
                  if len(current_row) >= 4:
                      if key not in previous_dict:
                          # New entry
                          changes.append({
                              'project': current_row[1],
                              'maintainer': current_row[2],
                              'company': current_row[3],
                              'github': current_row[4] if len(current_row) > 4 else '',
                              'change': 'Add'
                          })
                      elif current_row != previous_dict[key]:
                          # Updated entry
                          changes.append({
                              'project': current_row[1],
                              'maintainer': current_row[2],
                              'company': current_row[3],
                              'github': current_row[4] if len(current_row) > 4 else '',
                              'change': 'Update'
                          })
              
              # Find removals
              for key, previous_row in previous_dict.items():
                  if key not in current_dict and len(previous_row) >= 4:
                      changes.append({
                          'project': previous_row[1],
                          'maintainer': previous_row[2],
                          'company': previous_row[3],
                          'github': previous_row[4] if len(previous_row) > 4 else '',
                          'change': 'Remove'
                      })
              
              return changes
          
          changes = create_change_summary()
          
          # Create the output CSV content
          csv_content = "Project,Maintainer Name,Company,Email,GitHub Handle,Change\n"
          for change in changes:
              csv_content += f"{change['project']},{change['maintainer']},{change['company']},,{change['github']},{change['change']}\n"
          
          # Write to file for email
          with open('changes_summary.csv', 'w') as f:
              f.write(csv_content)
          
          # Set output for GitHub Actions
          print(f"Found {len(changes)} changes")
          with open(os.environ['GITHUB_OUTPUT'], 'a') as f:
              f.write(f"changes_count={len(changes)}\n")
              f.write(f"has_changes={'true' if changes else 'false'}\n")
          EOF

      - name: Add changes comment
        if: steps.analyze-changes.outputs.has_changes == 'true' && steps.check-requirements.outputs.all_required_complete == 'true'
        run: |
          # Create Markdown table from changes summary
          python3 << 'EOF'
          import csv
          import os
          
          def create_markdown_table():
              """Convert CSV changes to Markdown table"""
              if not os.path.exists('changes_summary.csv'):
                  return "No changes detected."
              
              with open('changes_summary.csv', 'r') as f:
                  reader = csv.reader(f)
                  rows = list(reader)
              
              if len(rows) <= 1:  # Only header or empty
                  return "No changes detected."
              
              # Create Markdown table
              table = "| Project | Maintainer Name | Company | Email | GitHub Handle | Change |\n"
              table += "|---------|-----------------|---------|-------|---------------|--------|\n"
              
              for row in rows[1:]:  # Skip header
                  if len(row) >= 6:
                      # Escape pipe characters in data and handle empty values
                      project = row[0].replace('|', '\\|') if row[0] else '-'
                      maintainer = row[1].replace('|', '\\|') if row[1] else '-'
                      company = row[2].replace('|', '\\|') if row[2] else '-'
                      email = row[3].replace('|', '\\|') if row[3] else '_To be filled manually_'
                      github = row[4].replace('|', '\\|') if row[4] else '-'
                      change = row[5].replace('|', '\\|') if row[5] else '-'
                      
                      # Add emoji for change type
                      change_emoji = {
                          'Add': '‚úÖ Add',
                          'Update': 'üîÑ Update', 
                          'Remove': '‚ùå Remove'
                      }.get(change, change)
                      
                      table += f"| {project} | {maintainer} | {company} | {email} | {github} | {change_emoji} |\n"
              
              return table
          
          markdown_table = create_markdown_table()
          
          # Write to file for use in next step
          with open('changes_table.md', 'w') as f:
              f.write(markdown_table)
          EOF
          
          # Read the generated table and post comment
          CHANGES_TABLE=$(cat changes_table.md)
          
          gh pr comment ${{ github.event.pull_request.number }} --body "## üìã Maintainer Changes Summary

          The following maintainer changes have been detected and are ready for processing:

          $CHANGES_TABLE

          ### Next Steps:
          - [ ] Fill in the Email column for each maintainer manually
          - [ ] Process changes according to internal procedures  
          - [ ] Update any necessary systems or send notifications
          - [ ] Verify all maintainer information is accurate

          _This summary was automatically generated from the CSV changes in this PR._"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload changes summary as artifact
        if: steps.analyze-changes.outputs.has_changes == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: maintainer-changes-${{ github.event.pull_request.number }}
          path: |
            changes_summary.csv
            changes_table.md